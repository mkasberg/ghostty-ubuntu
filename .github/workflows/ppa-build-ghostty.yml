name: Build Ghostty for PPA

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build (default: tip)'
        required: false
        type: string
        default: tip
      upload:
        description: 'Upload to PPA (default: false)'
        required: false
        default: false
        type: boolean

jobs:
  ghostty-build:
    name: Build Ghostty
    runs-on: ubuntu-latest
    container:
      image: ubuntu:25.10
    
    steps:
      - name: Checkout packaging repository
        uses: actions/checkout@v4

      - name: Add Ghostty PPA
        run: |
          apt-get update
          apt-get install -y software-properties-common
          add-apt-repository -y ppa:mkasberg/ghostty-ubuntu

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y git devscripts build-essential debhelper wget minisign dput gnupg equivs
          apt-get build-dep -y ./build-ppa/ghostty-nightly

      - name: Set up GPG signing
        run: |
          # Import GPG private key
          echo "${{ secrets.PPA_GPG_PRIVATE_KEY }}" | gpg --import --batch --no-tty
          
          # Configure GPG agent for non-interactive signing
          cat > ~/.gnupg/gpg-agent.conf << 'EOF'
          allow-loopback-pinentry
          EOF
          chmod 600 ~/.gnupg/gpg-agent.conf
          
          # Configure GPG for non-interactive signing
          cat > ~/.gnupg/gpg.conf << 'EOF'
          pinentry-mode loopback
          EOF
          chmod 600 ~/.gnupg/gpg.conf
          
          gpgconf --kill gpg-agent
          gpgconf --launch gpg-agent

      - name: Configure dput
        run: |
          # Create dput configuration for the PPA
          cat > ~/.dput.cf << 'EOF'
          [ghostty-ubuntu]
          fqdn = ppa.launchpad.net
          method = https
          incoming = ~mkasberg/ghostty-ubuntu/ubuntu/
          login = anonymous
          allow_unsigned_uploads = 0
          EOF

      - name: Run ghostty build
        run: |
          # Set GPG passphrase if provided
          if [ -n "${{ secrets.PPA_GPG_PASSPHRASE }}" ]; then
            export GPG_TTY=$(tty)
            echo "${{ secrets.PPA_GPG_PASSPHRASE }}" | gpg --passphrase-fd 0 --batch --no-tty --pinentry-mode loopback --clearsign --output /dev/null /dev/null
          fi
          
          # Run the build script
          VERSION="${{ github.event.inputs.version || 'tip' }}"
          ./build-ppa/build-ghostty.sh "$VERSION"
        env:
          DEBEMAIL: "kasberg.mike@gmail.com"
          DEBFULLNAME: "Mike Kasberg"

      - name: Upload to PPA
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.upload == 'true')
        run: |
          # Set GPG passphrase if provided
          if [ -n "${{ secrets.PPA_GPG_PASSPHRASE }}" ]; then
            export GPG_TTY=$(tty)
            echo "${{ secrets.PPA_GPG_PASSPHRASE }}" | gpg --passphrase-fd 0 --batch --no-tty --pinentry-mode loopback --clearsign --output /dev/null /dev/null
          fi
          
          # Determine the package name based on version
          VERSION="${{ github.event.inputs.version || 'tip' }}"
          if [[ "$VERSION" == "tip" ]]; then
            dput ppa:mkasberg/ghostty-ubuntu ghostty-nightly_*_source.changes
          else
            dput ppa:mkasberg/ghostty-ubuntu ghostty_*_source.changes
          fi
