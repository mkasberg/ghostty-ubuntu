name: Build Ghostty for PPA

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build (default: tip)'
        required: false
        type: string
        default: tip
      upload:
        description: 'Upload to PPA (default: false)'
        required: false
        default: false
        type: boolean
      build_matrix:
        description: 'Build matrix as JSON string'
        required: true
        type: string
    secrets:
      PPA_GPG_PRIVATE_KEY:
        description: The private key used to sign the .deb
        required: false
      PPA_GPG_PASSPHRASE:
        description: The passphrase for the private key
        required: false

jobs:
  ghostty-build:
    name: Build Ghostty (${{ matrix.builds.codename }})
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(inputs.build_matrix) }}
    container:
      image: ${{ matrix.builds.container-image }}
    
    steps:
      - name: Checkout packaging repository
        uses: actions/checkout@v4

      - name: Add Ghostty PPA
        run: |
          apt-get update
          apt-get install -y software-properties-common
          add-apt-repository -y ppa:mkasberg/ghostty-ubuntu

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y git devscripts build-essential debhelper wget minisign dput gnupg equivs
          apt-get build-dep -y ./build-ppa/ghostty-nightly

      - name: Set up GPG signing
        if: inputs.upload
        env:
          PPA_GPG_PRIVATE_KEY: ${{ secrets.PPA_GPG_PRIVATE_KEY }}
        run: |
          # Import GPG private key
          echo "$PPA_GPG_PRIVATE_KEY" | gpg --import --batch --no-tty
          
          # Configure GPG agent for non-interactive signing
          cat > ~/.gnupg/gpg-agent.conf << 'EOF'
          allow-loopback-pinentry
          EOF
          chmod 600 ~/.gnupg/gpg-agent.conf
          
          # Configure GPG for non-interactive signing
          cat > ~/.gnupg/gpg.conf << 'EOF'
          pinentry-mode loopback
          EOF
          chmod 600 ~/.gnupg/gpg.conf
          
          gpgconf --kill gpg-agent
          gpgconf --launch gpg-agent

      - name: Configure dput
        if: inputs.upload
        run: |
          # Create dput configuration for the PPA
          cat > ~/.dput.cf << 'EOF'
          [ghostty-ubuntu]
          fqdn = ppa.launchpad.net
          method = https
          incoming = ~mkasberg/ghostty-ubuntu/ubuntu/
          login = anonymous
          allow_unsigned_uploads = 0
          EOF

      - name: Run ghostty build
        env:
          PPA_GPG_PASSPHRASE: ${{ secrets.PPA_GPG_PASSPHRASE }}
          DEBEMAIL: "kasberg.mike@gmail.com"
          DEBFULLNAME: "Mike Kasberg"
        run: |
          # Set GPG passphrase if provided
          if [ -n "$PPA_GPG_PASSPHRASE" ]; then
            export GPG_TTY=$(tty)
            echo "$PPA_GPG_PASSPHRASE" | gpg --passphrase-fd 0 --batch --no-tty --pinentry-mode loopback --clearsign --output /dev/null /dev/null
          fi
          SIGN_OPT=""
          if [ "${{ inputs.upload }}" = "true" ]; then
            SIGN_OPT="-s"
          fi
          
          # Run the build script
          VERSION="${{ github.event.inputs.version || 'tip' }}"
          ./build-ppa/build-ghostty.sh -c ${{ matrix.builds.codename }} -v "$VERSION" $SIGN_OPT

      - name: Upload to PPA
        if: inputs.upload
        env:
          PPA_GPG_PASSPHRASE: ${{ secrets.PPA_GPG_PASSPHRASE }}
        run: |
          # Set GPG passphrase if provided
          if [ -n "$PPA_GPG_PASSPHRASE" ]; then
            echo "Setting GPG Passphrase..."
            export GPG_TTY=$(tty)
            echo "$PPA_GPG_PASSPHRASE" | gpg --passphrase-fd 0 --batch --no-tty --pinentry-mode loopback --clearsign --output /dev/null /dev/null
          fi
          
          # Upload the Ghostty package
          cd build-ppa && dput ppa:mkasberg/ghostty-ubuntu ghostty*_source.changes
