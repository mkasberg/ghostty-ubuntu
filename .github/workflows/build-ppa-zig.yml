name: Build Zig for PPA

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (default: tip)'
        required: false
        default: 'tip'

jobs:
  build:
    name: Build and Upload Zig
    runs-on: ubuntu-latest
    container:
      image: ubuntu:25.10
    
    steps:
      - name: Checkout packaging repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y git devscripts build-essential debhelper wget minisign dput gnupg equivs
          apt-get build-dep -y ./build-ppa/zig0.15

      - name: Set up GPG signing
        run: |
          # Import GPG private key
          echo "${{ secrets.PPA_GPG_PRIVATE_KEY }}" | gpg --import --batch --no-tty
          
          # Configure GPG agent for non-interactive signing
          cat > ~/.gnupg/gpg-agent.conf << 'EOF'
          allow-loopback-pinentry
          EOF
          chmod 600 ~/.gnupg/gpg-agent.conf
          
          # Configure GPG for non-interactive signing
          cat > ~/.gnupg/gpg.conf << 'EOF'
          pinentry-mode loopback
          EOF
          chmod 600 ~/.gnupg/gpg.conf
          
          gpgconf --kill gpg-agent
          gpgconf --launch gpg-agent

      - name: Configure dput
        run: |
          # Create dput configuration for the PPA
          cat > ~/.dput.cf << 'EOF'
          [ghostty-ubuntu]
          fqdn = ppa.launchpad.net
          method = https
          incoming = ~mkasberg/ghostty-ubuntu/ubuntu/
          login = anonymous
          allow_unsigned_uploads = 0
          EOF

      - name: Run build
        run: |
          # Set GPG passphrase if provided
          if [ -n "${{ secrets.PPA_GPG_PASSPHRASE }}" ]; then
            export GPG_TTY=$(tty)
            echo "${{ secrets.PPA_GPG_PASSPHRASE }}" | gpg --passphrase-fd 0 --batch --no-tty --pinentry-mode loopback --clearsign --output /dev/null /dev/null
          fi
          
          # Run the build script
          VERSION="${{ github.event.inputs.version || 'tip' }}"
          ./build-ppa/build-zig.sh "$VERSION"
        env:
          DEBEMAIL: "kasberg.mike@gmail.com"
          DEBFULLNAME: "Mike Kasberg"
