name: Build Zig for PPA

on:
  workflow_call:
    inputs:
      upload:
        description: 'Upload to PPA (default: false)'
        required: false
        default: false
        type: boolean
      build_matrix:
        description: 'Build matrix as JSON string'
        required: true
        type: string
      codename:
        description: 'Ubuntu codename to build for'
        required: false
        default: 'questing'
        type: string
      container-image:
        description: 'Container image to use for build'
        required: false
        default: 'ubuntu:25.10'
        type: string

jobs:
  build:
    name: Build Zig (${{ matrix.builds.codename }})
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(inputs.build_matrix) }}
    container:
      image: ${{ matrix.builds.container-image }}
    
    steps:
      - name: Checkout packaging repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y git devscripts build-essential debhelper wget minisign dput gnupg equivs
          apt-get build-dep -y ./build-ppa/zig0.15

      - name: Set up GPG signing
        if: inputs.upload
        run: |
          # Import GPG private key
          echo "${{ secrets.PPA_GPG_PRIVATE_KEY }}" | gpg --import --batch --no-tty
          
          # Configure GPG agent for non-interactive signing
          cat > ~/.gnupg/gpg-agent.conf << 'EOF'
          allow-loopback-pinentry
          EOF
          chmod 600 ~/.gnupg/gpg-agent.conf
          
          # Configure GPG for non-interactive signing
          cat > ~/.gnupg/gpg.conf << 'EOF'
          pinentry-mode loopback
          EOF
          chmod 600 ~/.gnupg/gpg.conf
          
          gpgconf --kill gpg-agent
          gpgconf --launch gpg-agent

      - name: Configure dput
        if: inputs.upload
        run: |
          # Create dput configuration for the PPA
          cat > ~/.dput.cf << 'EOF'
          [ghostty-ubuntu]
          fqdn = ppa.launchpad.net
          method = https
          incoming = ~mkasberg/ghostty-ubuntu/ubuntu/
          login = anonymous
          allow_unsigned_uploads = 0
          EOF

      - name: Run build
        run: |
          # Set GPG passphrase if provided
          if [ -n "${{ secrets.PPA_GPG_PASSPHRASE }}" ]; then
            export GPG_TTY=$(tty)
            echo "${{ secrets.PPA_GPG_PASSPHRASE }}" | gpg --passphrase-fd 0 --batch --no-tty --pinentry-mode loopback --clearsign --output /dev/null /dev/null
          fi
          SIGN_OPT=""
          if [[ "${{ inputs.upload }}" == 'true' ]]; then
            SIGN_OPT="-s"
          fi
          
          # Run the build script
          ./build-ppa/build-zig.sh -c ${{ matrix.builds.codename }} $SIGN_OPT
        env:
          DEBEMAIL: "kasberg.mike@gmail.com"
          DEBFULLNAME: "Mike Kasberg"

      - name: Upload to PPA
        if: inputs.upload
        run: |
          # Set GPG passphrase if provided
          if [ -n "${{ secrets.PPA_GPG_PASSPHRASE }}" ]; then
            export GPG_TTY=$(tty)
            echo "${{ secrets.PPA_GPG_PASSPHRASE }}" | gpg --passphrase-fd 0 --batch --no-tty --pinentry-mode loopback --clearsign --output /dev/null /dev/null
          fi
          
          # Upload the Zig package
          dput ppa:mkasberg/ghostty-ubuntu zig0.15_*_source.changes
